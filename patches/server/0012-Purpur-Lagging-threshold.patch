From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: William Blake Galbreath <blake.galbreath@gmail.com>
Date: Tue, 23 Jul 2019 10:07:16 -0500
Subject: [PATCH] Purpur: Lagging threshold

Original license: MIT
Original project: https://github.com/PurpurMC/Purpur

diff --git a/src/main/java/net/minecraft/server/MinecraftServer.java b/src/main/java/net/minecraft/server/MinecraftServer.java
index 62d5f67f9bfbffe7d8d8170ecef0aa977b048228..0ce5c9e0fa87b8ba574e0b4b4ac4f4b231609b3b 100644
--- a/src/main/java/net/minecraft/server/MinecraftServer.java
+++ b/src/main/java/net/minecraft/server/MinecraftServer.java
@@ -408,6 +408,7 @@ public abstract class MinecraftServer extends MinecraftServerBlockableEventLoop
     public final io.papermc.paper.configuration.PaperConfigurations paperConfigurations;
     public final GaleConfigurations galeConfigurations; // Gale - Gale configuration
     public static long currentTickLong = 0L; // Paper
+    public boolean lagging = false; // Purpur
 
     public volatile Thread shutdownThread; // Paper
     public volatile boolean abnormalExit = false; // Paper
@@ -1273,6 +1274,7 @@ public abstract class MinecraftServer extends MinecraftServerBlockableEventLoop
                     this.recentTps[1] = tps5.getAverage();
                     this.recentTps[2] = tps15.getAverage();
                     // Paper end
+                        lagging = recentTps[0] < org.dreeam.leaf.LeafConfig.laggingThreshold; // Purpur
                     tickSection = curTime;
                 }
                 // Spigot end
diff --git a/src/main/java/org/bukkit/craftbukkit/CraftServer.java b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
index 76e96b8a57bb84b92abc7932b8fed2950aaa87bb..2935b3d08fc186abd191f2f2c6f5157cfc45da6b 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftServer.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
@@ -2994,4 +2994,10 @@ public final class CraftServer implements Server {
     }
     // Gale end - YAPFA - last tick time - API
 
+    // Purpur start
+    @Override
+    public boolean isLagging() {
+        return getServer().lagging;
+    }
+    // Purpur end
 }
diff --git a/src/main/java/org/dreeam/leaf/LeafConfig.java b/src/main/java/org/dreeam/leaf/LeafConfig.java
index b9ade5d89b8dd48b075338e0f61c54aee5fa72ae..d16699e35a17b78364f7d47d69cbeb4ab76c00a1 100644
--- a/src/main/java/org/dreeam/leaf/LeafConfig.java
+++ b/src/main/java/org/dreeam/leaf/LeafConfig.java
@@ -183,6 +183,11 @@ public class LeafConfig {
         maxUseItemDistance = getDouble("max-UseItem-distance", maxUseItemDistance, "The max distance of UseItem for players");
     }
 
+    public static double laggingThreshold = 19.0D;
+    private static void performance() {
+        laggingThreshold = getDouble("performance.lagging-threshold", laggingThreshold);
+    }
+
     public static String commandTPSBarOutput = "<green>Tpsbar toggled <onoff> for <target>";
     public static String commandTPSBarTitle = "<gray>TPS<yellow>:</yellow> <tps> MSPT<yellow>:</yellow> <mspt> Ping<yellow>:</yellow> <ping>ms";
     public static BossBar.Overlay commandTPSBarProgressOverlay = BossBar.Overlay.NOTCHED_20;
